<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarReliability Pro - المحلل المتقدم</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;500;600;700;800&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.rtl.min.css">
    
    <style>
        /* ====== RESET & BASE ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #3B82F6;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --success: #10B981;
            --dark: #111827;
            --light: #F9FAFB;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            --sidebar-width: 380px;
            --header-height: 64px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Almarai', 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--gray-900);
            overflow-x: hidden;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ====== APP CONTAINER ====== */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* ====== HEADER - PROFESSIONAL DESIGN ====== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
            display: flex;
            align-items: center;
            padding: 0 24px;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: var(--shadow-md);
        }

        .logo-text {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .logo-text span {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .quick-search {
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .quick-search input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-family: 'Almarai', sans-serif;
            font-size: 15px;
            transition: var(--transition-base);
            background: white;
        }

        .quick-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .quick-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-action {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--gray-200);
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
        }

        .header-action:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            color: var(--gray-800);
            transform: translateY(-1px);
        }

        .header-action.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary);
        }

        .menu-toggle {
            display: none;
        }

        /* ====== SIDEBAR - PROFESSIONAL DESIGN ====== */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(4px);
        }

        .sidebar-overlay.active {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform var(--transition-slow) cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            border-left: 1px solid var(--gray-200);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        .sidebar-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border: none;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .sidebar-close:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 24px;
        }

        .sidebar-tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            font-family: 'Almarai', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .sidebar-tab i {
            font-size: 16px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        /* ====== SEARCH FORM ====== */
        .form-section {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-select,
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: 'Almarai', sans-serif;
            font-size: 15px;
            transition: var(--transition-base);
            background: white;
            appearance: none;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Almarai', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(37, 99, 235, 0.25);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1.5px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* ====== MAIN CONTENT ====== */
        .main-content {
            flex: 1;
            padding: 24px;
            margin-top: var(--header-height);
            overflow-y: auto;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        /* ====== WELCOME SCREEN ====== */
        .welcome-hero {
            text-align: center;
            padding: 80px 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: var(--radius-lg);
            margin-bottom: 40px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
        }

        .hero-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 36px;
            box-shadow: var(--shadow-lg);
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto 40px;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* ====== REPORT VIEW ====== */
        .report-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-md);
        }

        .car-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .car-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: 24px;
        }

        .rating-summary {
            display: flex;
            align-items: center;
            gap: 32px;
            margin-bottom: 24px;
        }

        .overall-rating {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .rating-badge {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 800;
            box-shadow: var(--shadow-md);
        }

        .rating-stars {
            display: flex;
            gap: 4px;
        }

        .rating-stars i {
            color: #FFD700;
            font-size: 1.5rem;
        }

        .rating-label {
            font-size: 1rem;
            color: var(--gray-600);
            margin-top: 8px;
        }

        .summary-text {
            flex: 1;
            font-size: 1.125rem;
            line-height: 1.6;
            color: var(--gray-700);
        }

        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .component-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--gray-200);
            transition: var(--transition-base);
            cursor: pointer;
        }

        .component-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .component-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .component-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .component-rating {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .rating-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .rating-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        /* ====== COMPARISON VIEW ====== */
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .comparison-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            border: 1px solid var(--gray-200);
        }

        .comparison-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .comparison-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        /* ====== MODAL ====== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn var(--transition-base);
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            animation: modalIn var(--transition-base);
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* ====== ANIMATIONS ====== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* ====== LOADING STATES ====== */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(37, 99, 235, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ====== RESPONSIVE DESIGN ====== */
        @media (max-width: 1200px) {
            .components-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 100%;
                max-width: 400px;
            }
            
            .header-center {
                display: none;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 16px;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .rating-summary {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 1.75rem;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* ====== UTILITY CLASSES ====== */
        .mb-4 { margin-bottom: 16px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-4 { margin-top: 16px; }
        .mt-8 { margin-top: 32px; }
        .text-center { text-align: center; }
        .d-none { display: none; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: 16px; }
        .w-100 { width: 100%; }

        /* Color coding for ratings */
        .rating-excellent { color: #10B981; }
        .rating-good { color: #3B82F6; }
        .rating-average { color: #F59E0B; }
        .rating-poor { color: #F97316; }
        .rating-bad { color: #EF4444; }

        .bg-excellent { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .bg-good { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        .bg-average { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .bg-poor { background: linear-gradient(135deg, #F97316 0%, #EA580C 100%); }
        .bg-bad { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
    </style>
</head>
<body>
    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="header-action menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="logo-text">
                        <span>CarReliability</span> Pro
                    </div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="quick-search">
                    <i class="fas fa-search quick-search-icon"></i>
                    <input type="text" placeholder="ابحث عن أي سيارة (مثال: تويوتا كامري 2020)" id="globalSearch">
                </div>
            </div>
            
            <div class="header-right">
                <button class="header-action" id="themeToggle" title="تبديل السمة">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="header-action" id="languageToggle" title="تبديل اللغة">
                    <i class="fas fa-language"></i>
                </button>
                <button class="header-action" id="searchToggle" title="بحث متقدم">
                    <i class="fas fa-search"></i>
                </button>
                <button class="header-action" id="testAPI" title="اختبار API" style="background: #10B981; color: white;">
                    <i class="fas fa-plug"></i>
                </button>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">القائمة الرئيسية</h3>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="search">
                    <i class="fas fa-search"></i>
                    <span>بحث</span>
                </button>
                <button class="sidebar-tab" data-tab="compare">
                    <i class="fas fa-balance-scale"></i>
                    <span>مقارنة</span>
                </button>
                <button class="sidebar-tab" data-tab="history">
                    <i class="fas fa-history"></i>
                    <span>السجل</span>
                </button>
            </div>
            
            <div class="sidebar-content">
                <!-- Search Tab -->
                <div class="tab-pane active" id="searchTab">
                    <div class="form-section">
                        <h4 class="form-title">
                            <i class="fas fa-car"></i>
                            ابحث عن موثوقية أي سيارة
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">العلامة التجارية</label>
                                <select class="form-select" id="carMake" required>
                                    <option value="">اختر العلامة</option>
                                    <option value="Toyota">تويوتا</option>
                                    <option value="Mitsubishi">ميتسوبيشي</option>
                                    <option value="Nissan">نيسان</option>
                                    <option value="Hyundai">هيونداي</option>
                                    <option value="Kia">كيا</option>
                                    <option value="Mercedes">مرسيدس</option>
                                    <option value="BMW">بي إم دبليو</option>
                                    <option value="Chevrolet">شيفروليه</option>
                                    <option value="Ford">فورد</option>
                                    <option value="GMC">GMC</option>
                                    <option value="Honda">هوندا</option>
                                    <option value="Mazda">مازدا</option>
                                    <option value="Lexus">لكزس</option>
                                    <option value="Audi">أودي</option>
                                    <option value="Volkswagen">فولكس فاجن</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">الموديل</label>
                                <input type="text" class="form-input" id="carModel" placeholder="أدخل اسم الموديل" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">السنة</label>
                                <select class="form-select" id="carYear" required>
                                    <option value="">اختر السنة</option>
                                    <!-- Years populated by JS -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">الكيلومترات (كم)</label>
                                <input type="number" class="form-input" id="carMileage" placeholder="مثال: 120000" min="0" max="1000000">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ناقل الحركة</label>
                                <select class="form-select" id="carTransmission">
                                    <option value="">جميع الأنواع</option>
                                    <option value="automatic">أوتوماتيك</option>
                                    <option value="manual">يدوي</option>
                                    <option value="cvt">CVT</option>
                                    <option value="dsg">DSG</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">نوع الوقود</label>
                                <select class="form-select" id="carFuel">
                                    <option value="">جميع الأنواع</option>
                                    <option value="petrol">بنزين</option>
                                    <option value="diesel">ديزل</option>
                                    <option value="hybrid">هايبرد</option>
                                    <option value="electric">كهربائي</option>
                                </select>
                            </div>
                            
                            <div class="form-group full-width">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="gccSpec" checked>
                                    <span>مواصفات الخليج (GCC)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" id="analyzeBtn">
                                <i class="fas fa-robot"></i>
                                تحليل بالذكاء الاصطناعي
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-title">
                            <i class="fas fa-bolt"></i>
                            البحث السريع
                        </h4>
                        <div class="quick-search-buttons">
                            <button class="btn btn-secondary" data-search="تويوتا كامري 2020">
                                <i class="fas fa-bolt"></i>
                                تويوتا كامري 2020
                            </button>
                            <button class="btn btn-secondary" data-search="نيسان باترول 2018">
                                <i class="fas fa-bolt"></i>
                                نيسان باترول 2018
                            </button>
                            <button class="btn btn-secondary" data-search="ميتسوبيشي باجيرو 2015">
                                <i class="fas fa-bolt"></i>
                                ميتسوبيشي باجيرو 2015
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Compare Tab -->
                <div class="tab-pane" id="compareTab">
                    <div class="form-section">
                        <h4 class="form-title">
                            <i class="fas fa-balance-scale"></i>
                            مقارنة بين سيارتين
                        </h4>
                        
                        <div class="form-section" style="background: #f0f9ff; border: 1px dashed #93c5fd;">
                            <h5>السيارة الأولى</h5>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <input type="text" class="form-input" id="compareCar1" placeholder="ابحث أو أدخل اسم السيارة">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">السنة</label>
                                    <input type="text" class="form-input" id="compareYear1" placeholder="2020">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الكيلومترات</label>
                                    <input type="text" class="form-input" id="compareMileage1" placeholder="120000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section" style="background: #fef7ff; border: 1px dashed #d8b4fe; margin-top: 16px;">
                            <h5>السيارة الثانية</h5>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <input type="text" class="form-input" id="compareCar2" placeholder="ابحث أو أدخل اسم السيارة">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">السنة</label>
                                    <input type="text" class="form-input" id="compareYear2" placeholder="2018">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الكيلومترات</label>
                                    <input type="text" class="form-input" id="compareMileage2" placeholder="150000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions mt-4">
                            <button class="btn btn-primary" id="compareBtn">
                                <i class="fas fa-balance-scale"></i>
                                بدء المقارنة
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div class="tab-pane" id="historyTab">
                    <div class="form-section">
                        <h4 class="form-title">
                            <i class="fas fa-history"></i>
                            سجل البحث
                        </h4>
                        
                        <div id="historyList">
                            <!-- History items populated by JS -->
                        </div>
                        
                        <div class="form-actions mt-4">
                            <button class="btn btn-secondary w-100" id="clearHistoryBtn">
                                <i class="fas fa-trash"></i>
                                مسح السجل
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen">
                <div class="welcome-hero">
                    <div class="hero-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h1 class="hero-title">المحلل المتقدم لموثوقية السيارات</h1>
                    <p class="hero-subtitle">
                        اكتشف موثوقية أي سيارة باستخدام الذكاء الاصطناعي المتقدم. 
                        تحليل مفصل للمحرك، ناقل الحركة، النظام الكهربائي، وتكاليف الإصلاح في دول الخليج.
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value">50,000+</span>
                            <span class="stat-label">سيارة محللة</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">98.7%</span>
                            <span class="stat-label">دقة التحليل</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">24/7</span>
                            <span class="stat-label">دعم فني</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">10,000+</span>
                            <span class="stat-label">مشترك جديد</span>
                        </div>
                    </div>
                </div>
                
                <div class="components-grid">
                    <div class="component-card" onclick="openTab('search')">
                        <div class="component-header">
                            <h3 class="component-name">
                                <i class="fas fa-search" style="color: var(--primary);"></i>
                                بحث متقدم
                            </h3>
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            ابحث عن أي سيارة واحصل على تحليل مفصل لموثوقيتها ومشاكلها الشائعة
                        </p>
                    </div>
                    
                    <div class="component-card" onclick="openTab('compare')">
                        <div class="component-header">
                            <h3 class="component-name">
                                <i class="fas fa-balance-scale" style="color: var(--success);"></i>
                                مقارنة ذكية
                            </h3>
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            قارن بين سيارتين لاتخاذ القرار الأمثل بناءً على البيانات
                        </p>
                    </div>
                    
                    <div class="component-card" onclick="showDemoReport()">
                        <div class="component-header">
                            <h3 class="component-name">
                                <i class="fas fa-eye" style="color: var(--warning);"></i>
                                عرض تجريبي
                            </h3>
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            شاهد مثالاً حياً لتحليل ذكي متكامل لسيارة تويوتا كامري
                        </p>
                    </div>
                    
                    <div class="component-card" onclick="openTab('history')">
                        <div class="component-header">
                            <h3 class="component-name">
                                <i class="fas fa-history" style="color: var(--secondary);"></i>
                                سجل البحث
                            </h3>
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            عد إلى سياراتك المحللة سابقاً أو أضفها للمقارنة
                        </p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="d-none">
                <div class="welcome-hero" style="min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div class="loading-spinner mb-8"></div>
                    <h2 class="hero-title mb-4">جارٍ تحليل طلبك</h2>
                    <p class="hero-subtitle">
                        يستخدم الذكاء الاصطناعي لدينا أحدث التقنيات لتحليل موثوقية سيارتك
                    </p>
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <div style="padding: 12px 24px; background: #f0f9ff; border-radius: var(--radius-md); color: var(--primary);">
                            <i class="fas fa-database"></i> قاعدة بيانات السيارات
                        </div>
                        <div style="padding: 12px 24px; background: #f0fdf4; border-radius: var(--radius-md); color: var(--success);">
                            <i class="fas fa-brain"></i> تحليل الذكاء الاصطناعي
                        </div>
                        <div style="padding: 12px 24px; background: #fffbeb; border-radius: var(--radius-md); color: var(--warning);">
                            <i class="fas fa-calculator"></i> حساب التكاليف
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results State -->
            <div id="resultsState" class="d-none">
                <!-- Report will be populated by JavaScript -->
            </div>

            <!-- Comparison State -->
            <div id="comparisonState" class="d-none">
                <div class="report-header">
                    <h2 class="car-title">مقارنة موثوقية السيارات</h2>
                    <p class="car-subtitle">تحليل مقارن ذكي بين سيارتين</p>
                </div>
                
                <div id="comparisonContainer">
                    <!-- Comparison will be populated by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Component Details Modal -->
    <div class="modal" id="componentModal">
        <div class="modal-content">
            <div class="report-header" style="border-bottom: 1px solid var(--gray-200);">
                <div class="d-flex align-center justify-between">
                    <h3 id="modalComponentName">تفاصيل الجزء</h3>
                    <button class="header-action" id="modalClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div style="padding: 24px;">
                <div id="modalContent">
                    <!-- Modal content populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // ====== GLOBAL STATE ======
        const APP_STATE = {
            currentCar: null,
            comparisonCars: [],
            searchHistory: JSON.parse(localStorage.getItem('carSearchHistory')) || [],
            language: 'ar',
            theme: localStorage.getItem('theme') || 'light',
            apiKey: 'sk-51d5e8f3e2c7490680ccd30bbdba4cf6',
            apiBaseUrl: 'https://api.deepseek.com/v1/chat/completions'
        };

        // ====== CAR DATABASE ======
        const CAR_DATABASE = {
            makes: [
                'تويوتا', 'نيسان', 'ميتسوبيشي', 'هوندا', 'هيونداي', 'كيا',
                'مرسيدس', 'بي إم دبليو', 'أودي', 'فولكس فاجن', 'شيفروليه',
                'فورد', 'GMC', 'لكزس', 'انفينيتي', 'جاكوار', 'لاند روفر',
                'بورش', 'فولفو', 'مازدا', 'سوبارو', 'سوزوكي', 'بيجو',
                'رينو', 'سيات', 'سكودا', 'فيات', 'ألفا روميو', 'ميني'
            ],
            
            models: {
                'تويوتا': ['كامري', 'كورولا', 'لاند كروزر', 'برادو', 'هيلوكس', 'راف فور', 'يارس', 'افالون', 'سييننا', 'هايلكس'],
                'نيسان': ['باترول', 'صني', 'قاشقاي', 'اكستيرا', 'سنترا', 'ماكسيما', 'فيرسا', 'التيما', 'ارمادا', 'جوك'],
                'ميتسوبيشي': ['باجيرو', 'لانسر', 'اوتلاندر', 'ميراج', 'اشوكا', 'ترايتون', 'ايكليبس كروس'],
                'هيونداي': ['سوناتا', 'اكسنت', 'توسان', 'سانتافي', 'اكسيل', 'فيرنا', 'النترا', 'باليسيد', 'كريتا'],
                'كيا': ['سبورتيج', 'سورينتو', 'سيراتو', 'بيكانتو', 'سول', 'كارنيفال', 'ستينجر', 'سيد'],
                'مرسيدس': ['فئة C', 'فئة E', 'فئة S', 'GLC', 'GLE', 'GLA', 'A-Class', 'CLA'],
                'بي إم دبليو': ['السلسلة 3', 'السلسلة 5', 'السلسلة 7', 'X3', 'X5', 'X1', 'X6'],
                'شيفروليه': ['لومينا', 'ماليبو', 'كروز', 'تاهو', 'سوبربان', 'كابريس', 'سيلفرادو'],
                'فورد': ['فوكس', 'فيوجن', 'إكسبلورر', 'إسكيب', 'إيدج', 'موستانج', 'F-150'],
                'GMC': ['يوكون', 'سوبربان', 'سيرا', 'أكاديا', 'سييرا', 'كانيون']
            }
        };

        // ====== INITIALIZATION ======
        $(document).ready(function() {
            initializeApp();
            setupEventListeners();
            populateCarData();
            setTheme(APP_STATE.theme);
        });

        function initializeApp() {
            // Set initial theme
            updateThemeIcon();
            
            // Initialize UI components
            initializeSelects();
            
            // Load history
            updateHistoryList();
            
            // Set current screen
            showScreen('welcome');
        }

        function setupEventListeners() {
            // Sidebar
            $('#menuToggle, #searchToggle').click(openSidebar);
            $('#sidebarClose, #sidebarOverlay').click(closeSidebar);
            
            // Sidebar tabs
            $('.sidebar-tab').click(function() {
                const tab = $(this).data('tab');
                switchTab(tab);
            });
            
            // Search form
            $('#analyzeBtn').click(handleCarSearch);
            
            // Quick search buttons
            $('.quick-search-buttons button').click(function() {
                const searchText = $(this).data('search');
                $('#globalSearch').val(searchText);
                handleQuickSearch(searchText);
            });
            
            // Global search
            $('#globalSearch').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    handleQuickSearch($(this).val());
                }
            });
            
            // Compare
            $('#compareBtn').click(handleComparison);
            
            // Theme toggle
            $('#themeToggle').click(toggleTheme);
            
            // Language toggle
            $('#languageToggle').click(toggleLanguage);
            
            // Test API button
            $('#testAPI').click(testAPIConnection);
            
            // Modal close
            $('#modalClose').click(closeModal);
            $('#componentModal').click(function(e) {
                if (e.target === this) closeModal();
            });
            
            // Clear history
            $('#clearHistoryBtn').click(clearHistory);
        }

        function populateCarData() {
            // Populate years
            const currentYear = new Date().getFullYear();
            const yearSelect = $('#carYear');
            for (let year = currentYear; year >= 1990; year--) {
                yearSelect.append(`<option value="${year}">${year}</option>`);
            }
            
            // Populate make suggestions
            const makeSelect = $('#carMake');
            CAR_DATABASE.makes.forEach(make => {
                makeSelect.append(`<option value="${make}">${make}</option>`);
            });
        }

        function initializeSelects() {
            $('.ui.dropdown').dropdown();
        }

        // ====== SIDEBAR FUNCTIONS ======
        function openSidebar() {
            $('#sidebar').addClass('active');
            $('#sidebarOverlay').addClass('active');
            $('body').css('overflow', 'hidden');
        }

        function closeSidebar() {
            $('#sidebar').removeClass('active');
            $('#sidebarOverlay').removeClass('active');
            $('body').css('overflow', 'auto');
        }

        function switchTab(tab) {
            // Update active tab
            $('.sidebar-tab').removeClass('active');
            $(`.sidebar-tab[data-tab="${tab}"]`).addClass('active');
            
            // Show corresponding content
            $('.tab-pane').removeClass('active');
            $(`#${tab}Tab`).addClass('active');
            
            // If history tab, refresh list
            if (tab === 'history') {
                updateHistoryList();
            }
        }

        function openTab(tab) {
            openSidebar();
            setTimeout(() => switchTab(tab), 100);
        }

        // ====== SEARCH FUNCTIONS ======
        async function handleCarSearch() {
            const carData = {
                make: $('#carMake').val(),
                model: $('#carModel').val(),
                year: $('#carYear').val(),
                mileage: $('#carMileage').val() || null,
                transmission: $('#carTransmission').val() || null,
                fuel: $('#carFuel').val() || null,
                gcc: $('#gccSpec').is(':checked')
            };
            
            if (!carData.make || !carData.model || !carData.year) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // Add to history
            addToHistory(carData);
            
            // Close sidebar
            closeSidebar();
            
            // Show loading
            showScreen('loading');
            
            // Get analysis
            try {
                const report = await getCarAnalysis(carData);
                APP_STATE.currentCar = report;
                displayCarReport(report);
                showScreen('results');
            } catch (error) {
                console.error('Error:', error);
                showNotification('حدث خطأ أثناء التحليل', 'error');
                showScreen('welcome');
            }
        }

        function handleQuickSearch(query) {
            if (!query.trim()) return;
            
            // Parse query (simple parsing)
            const parts = query.split(' ');
            let year = null;
            let make = null;
            let model = null;
            
            // Find year
            for (let part of parts) {
                if (/^\d{4}$/.test(part)) {
                    year = part;
                    break;
                }
            }
            
            // Simple matching for make and model
            for (let makeName of CAR_DATABASE.makes) {
                if (query.includes(makeName)) {
                    make = makeName;
                    break;
                }
            }
            
            if (make) {
                // Try to find model
                const possibleModels = CAR_DATABASE.models[make] || [];
                for (let modelName of possibleModels) {
                    if (query.includes(modelName)) {
                        model = modelName;
                        break;
                    }
                }
            }
            
            if (make && model && year) {
                // Fill form and search
                $('#carMake').val(make);
                $('#carModel').val(model);
                $('#carYear').val(year);
                handleCarSearch();
            } else {
                showNotification('لم نتعرف على السيارة بالكامل. استخدم البحث المتقدم.', 'warning');
                openTab('search');
            }
        }

        // ====== DEEPSEEK AI ANALYSIS FUNCTIONS ======
        async function getCarAnalysis(carData) {
            try {
                // Create prompt for DeepSeek AI
                const prompt = `
أنت محلل خبير لموثوقية السيارات في دول الخليج. قم بتحليل الموثوقية للسيارة التالية:
- العلامة التجارية: ${carData.make}
- الموديل: ${carData.model}
- السنة: ${carData.year}
- الكيلومترات: ${carData.mileage || 'غير محدد'}
- ناقل الحركة: ${carData.transmission || 'غير محدد'}
- نوع الوقود: ${carData.fuel || 'غير محدد'}
- مواصفات الخليج: ${carData.gcc ? 'نعم' : 'لا'}

أرجو إعطاء تحليل شامل يتضمن:
1. تقييم شامل من 1-5
2. ملخص عام
3. تحليل الأجزاء الرئيسية (المحرك، ناقل الحركة، النظام الكهربائي، نظام التعليق، نظام الفرامل، نظام التكييف)
4. المشاكل الشائعة وتكاليف الإصلاح
5. نصائح خاصة لمناخ الخليج

يرجى تقديم النتائج باللغة العربية وبشكل منظم.
                `;

                const response = await axios.post(APP_STATE.apiBaseUrl, {
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'system',
                            content: 'أنت خبير في موثوقية السيارات في دول الخليج. قدم تحليلات دقيقة ومفيدة باللغة العربية.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000,
                    stream: false
                }, {
                    headers: {
                        'Authorization': `Bearer ${APP_STATE.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Parse the AI response
                const aiResponse = response.data.choices[0].message.content;
                return parseAIResponseToReport(aiResponse, carData);
                
            } catch (error) {
                console.error('DeepSeek API Error:', error);
                showNotification('خطأ في الاتصال بالذكاء الاصطناعي. استخدام بيانات تجريبية.', 'warning');
                // Fallback to mock data
                return generateMockReport(carData);
            }
        }

        function parseAIResponseToReport(aiResponse, carData) {
            // Parse the AI response and extract information
            const lines = aiResponse.split('\n');
            
            // Extract overall rating
            let overallRating = extractRatingFromText(aiResponse);
            if (!overallRating) {
                overallRating = 4.0 + (Math.random() * 0.5 - 0.25); // Random between 3.75-4.25
            }
            
            // Extract summary
            let summary = '';
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                if (lines[i].trim() && !lines[i].includes('تقييم') && !lines[i].includes('نقاط')) {
                    summary += lines[i].trim() + ' ';
                }
            }
            if (!summary) {
                summary = generateDefaultSummary(carData, overallRating);
            }
            
            // Create report
            const report = {
                ...carData,
                title: `${carData.make} ${carData.model} ${carData.year} ${carData.gcc ? '(مواصفات الخليج)' : ''}`,
                overallRating: overallRating,
                confidence: 85 + Math.floor(Math.random() * 10), // 85-95% confidence
                summary: summary,
                components: generateComponentsFromAI(aiResponse, carData.make, carData.model, overallRating),
                commonProblems: extractProblemsFromAI(aiResponse, carData.make, carData.model),
                gulfAdvice: extractGulfAdviceFromAI(aiResponse),
                analysisDate: new Date().toLocaleDateString('ar-SA'),
                id: Date.now(),
                aiResponse: aiResponse // Keep original for debugging
            };
            
            return report;
        }

        function extractRatingFromText(text) {
            // Try to find rating in text
            const ratingRegex = /(\d+(?:\.\d+)?)\s*\/\s*5|\b(?:تقييم|معدل|نقاط).*?(\d+(?:\.\d+)?)/;
            const match = text.match(ratingRegex);
            
            if (match) {
                let rating = parseFloat(match[1] || match[2]);
                if (!isNaN(rating) && rating >= 1 && rating <= 5) {
                    return rating;
                }
            }
            
            // Try to find number between 1-5
            const numberRegex = /\b([1-5](?:\.\d+)?)\b/;
            const numberMatch = text.match(numberRegex);
            if (numberMatch) {
                let rating = parseFloat(numberMatch[1]);
                if (!isNaN(rating) && rating >= 1 && rating <= 5) {
                    return rating;
                }
            }
            
            return null;
        }

        function generateDefaultSummary(carData, rating) {
            const summaries = [
                `بناءً على تحليل الذكاء الاصطناعي، ${carData.make} ${carData.model} ${carData.year} تظهر موثوقية ${rating >= 4.5 ? 'ممتازة' : rating >= 4 ? 'جيدة جداً' : rating >= 3.5 ? 'جيدة' : 'متوسطة'} في مناخ الخليج.`,
                `تحليلنا لـ ${carData.make} ${carData.model} يظهر أداءً ${rating >= 4.5 ? 'راقياً' : rating >= 4 ? 'متميزاً' : rating >= 3.5 ? 'مقبولاً' : 'يحتاج انتباهاً'} مع مراعاة الظروف المناخية في المنطقة.`,
                `${carData.make} ${carData.model} ${rating >= 4 ? 'خيار موثوق' : 'يحتاج صيانة دقيقة'} للاستخدام في دول الخليج حسب تحليل الذكاء الاصطناعي.`
            ];
            
            return summaries[Math.floor(Math.random() * summaries.length)];
        }

        function generateComponentsFromAI(aiResponse, make, model, overallRating) {
            const components = [
                { name: 'المحرك', icon: '⚙️', baseKey: 'محرك' },
                { name: 'ناقل الحركة', icon: '🔧', baseKey: 'ناقل' },
                { name: 'النظام الكهربائي', icon: '🔌', baseKey: 'كهربائي' },
                { name: 'نظام التعليق', icon: '🛞', baseKey: 'تعليق' },
                { name: 'نظام الفرامل', icon: '🛑', baseKey: 'فرامل' },
                { name: 'نظام التكييف', icon: '❄️', baseKey: 'تكييف' }
            ];
            
            return components.map(comp => {
                // Try to extract component-specific info from AI response
                let componentRating = extractComponentRating(aiResponse, comp.baseKey, overallRating);
                let componentSummary = extractComponentSummary(aiResponse, comp.baseKey, make, model);
                
                if (!componentSummary) {
                    componentSummary = generateComponentSummary(make, model, comp.name, componentRating);
                }
                
                return {
                    name: comp.name,
                    icon: comp.icon,
                    rating: componentRating,
                    summary: componentSummary,
                    detailedOverview: generateDetailedOverview(make, model, comp.name, componentRating),
                    commonProblems: generateComponentProblems(comp.name, componentRating),
                    maintenanceTips: generateMaintenanceTips(comp.name, componentRating),
                    ratingClass: getRatingClass(componentRating),
                    ratingColor: getRatingColor(componentRating)
                };
            });
        }

        function extractComponentRating(aiResponse, componentKey, overallRating) {
            // Look for component-specific rating
            const regex = new RegExp(`${componentKey}.*?(\\d+(?:\\.\\d+)?)`, 'i');
            const match = aiResponse.match(regex);
            
            if (match && match[1]) {
                const rating = parseFloat(match[1]);
                if (!isNaN(rating) && rating >= 1 && rating <= 5) {
                    return rating;
                }
            }
            
            // Default with variation from overall rating
            return Math.max(1, Math.min(5, overallRating + (Math.random() * 0.4 - 0.2)));
        }

        function extractComponentSummary(aiResponse, componentKey, make, model) {
            const lines = aiResponse.split('\n');
            let foundComponent = false;
            let summary = '';
            
            for (let line of lines) {
                if (line.includes(componentKey)) {
                    foundComponent = true;
                }
                
                if (foundComponent && line.trim() && !line.includes(componentKey)) {
                    summary = line.trim();
                    break;
                }
            }
            
            return summary || null;
        }

        function extractProblemsFromAI(aiResponse, make, model) {
            const problems = [];
            const lines = aiResponse.split('\n');
            let inProblemsSection = false;
            let problemCount = 0;
            
            for (let line of lines) {
                if (line.includes('مشاكل') || line.includes('عيوب') || line.includes('سلبيات')) {
                    inProblemsSection = true;
                    continue;
                }
                
                if (inProblemsSection && problemCount < 3 && line.trim() && line.length > 20) {
                    problems.push({
                        title: `مشكلة ${problemCount + 1}`,
                        cost: generateCost(problemCount),
                        urgency: ['عالي', 'متوسط', 'منخفض'][problemCount],
                        frequency: ['شائع', 'متوسط', 'نادر'][problemCount],
                        typicalMileage: ['80,000-120,000 كم', '100,000-150,000 كم', '120,000+ كم'][problemCount],
                        description: line.trim(),
                        solution: 'زيارة مركز صيانة معتمد وفحص السيارة بشكل دوري'
                    });
                    problemCount++;
                }
                
                if (problemCount >= 3) break;
            }
            
            // If no problems found in AI response, generate default ones
            if (problems.length === 0) {
                return generateDefaultProblems(make, model);
            }
            
            return problems;
        }

        function generateCost(index) {
            const costs = [
                '400-800 ر.س',
                '1,200-2,500 ر.س',
                '800-1,500 ر.س'
            ];
            return costs[index] || '500-1,000 ر.س';
        }

        function generateDefaultProblems(make, model) {
            return [
                {
                    title: 'استهلاك زيت مرتفع',
                    cost: '400-800 ر.س',
                    urgency: 'متوسط',
                    frequency: 'شائع بعد 100,000 كم',
                    typicalMileage: '80,000-120,000 كم',
                    description: `محرك ${make} ${model} قد يستهلك زيتاً أكثر من المتوسط، خاصة في درجات الحرارة العالية في الخليج.`,
                    solution: 'فحص مستوى الزيت أسبوعياً وتغييره كل 8,000 كم في الصيف.'
                },
                {
                    title: 'مشاكل في ناقل الحركة',
                    cost: '1,500-3,000 ر.س',
                    urgency: 'عالي',
                    frequency: 'متوسط',
                    typicalMileage: '100,000-150,000 كم',
                    description: 'انزلاق أو تأخر في التبديل بين التروس، خاصة في ناقل الحركة الأوتوماتيكي.',
                    solution: 'تغيير سائل ناقل الحركة كل 60,000 كم وفحص النظام بشكل دوري.'
                },
                {
                    title: 'ضعف في النظام الكهربائي',
                    cost: '800-1,500 ر.س',
                    urgency: 'منخفض',
                    frequency: 'نادر',
                    typicalMileage: '120,000+ كم',
                    description: 'مشاكل في البطارية أو الأنظمة الإلكترونية بسبب الحرارة العالية.',
                    solution: 'فحص البطارية قبل الصيف وتنظيف أقطابها بشكل دوري.'
                }
            ];
        }

        function extractGulfAdviceFromAI(aiResponse) {
            const advice = [];
            const lines = aiResponse.split('\n');
            let inAdviceSection = false;
            let adviceCount = 0;
            
            for (let line of lines) {
                if (line.includes('نصائح') || line.includes('توصيات') || line.includes('خليجي')) {
                    inAdviceSection = true;
                    continue;
                }
                
                if (inAdviceSection && adviceCount < 4 && line.trim() && line.length > 10) {
                    advice.push({
                        title: `نصيحة ${adviceCount + 1}`,
                        description: line.trim()
                    });
                    adviceCount++;
                }
                
                if (adviceCount >= 4) break;
            }
            
            // If no advice found, generate default
            if (advice.length === 0) {
                return generateDefaultGulfAdvice();
            }
            
            return advice;
        }

        function generateDefaultGulfAdvice() {
            return [
                {
                    title: 'العناية بالبطارية',
                    description: 'فحص البطارية قبل الصيف وتنظيف أقطابها بشكل دوري'
                },
                {
                    title: 'نظام التكييف',
                    description: 'تشغيل التكييف على درجة متوسطة للحفاظ على الضاغط'
                },
                {
                    title: 'تغيير الزيت',
                    description: 'تغيير زيت المحرك كل 8,000 كم في الصيف بدلاً من 10,000 كم'
                },
                {
                    title: 'الإطارات',
                    description: 'فحص ضغط الإطارات أسبوعياً واستخدام إطارات مناسبة للصيف'
                }
            ];
        }

        function generateComponentSummary(make, model, component, rating) {
            const summaries = {
                'المحرك': [
                    `محرك ${make} ${model} ${rating >= 4.5 ? 'ممتاز الموثوقية' : rating >= 4 ? 'جيد جداً' : 'يحتاج عناية'}`,
                    `أداء المحرك ${rating >= 4 ? 'مستقر' : 'متغير'} في درجات الحرارة العالية`
                ],
                'ناقل الحركة': [
                    `${rating >= 4 ? 'سلاسة في النقل' : 'يشكو من تأخر أحياناً'}`,
                    `ناقل ${rating >= 4 ? 'متين' : 'بحاجة فحص دوري'}`
                ],
                'النظام الكهربائي': [
                    `النظام الكهربائي ${rating >= 4 ? 'موثوق' : 'حساس للحرارة'}`,
                    `البطارية والإلكترونيات ${rating >= 4 ? 'تعمل بشكل جيد' : 'تحتاج مراقبة'}`
                ],
                'نظام التعليق': [
                    `التعليق ${rating >= 4 ? 'مريح' : 'قاسي أحياناً'}`,
                    `ملائم ${rating >= 4 ? 'للطرق' : 'بحاجة لتعديل'}`
                ],
                'نظام الفرامل': [
                    `الفرامل ${rating >= 4 ? 'فعّالة' : 'تحتاج صيانة مستمرة'}`,
                    `قدرة كبح ${rating >= 4 ? 'جيدة' : 'متوسطة'}`
                ],
                'نظام التكييف': [
                    `التكييف ${rating >= 4 ? 'بارد' : 'يحتاج صيانة'}`,
                    `مناسب ${rating >= 4 ? 'لحرارة الخليج' : 'لكنه يستهلك طاقة'}`
                ]
            };
            
            const options = summaries[component] || ['أداء جيد بشكل عام'];
            return options[Math.floor(Math.random() * options.length)];
        }

        function generateDetailedOverview(make, model, component, rating) {
            const overviews = {
                'المحرك': `محرك ${make} ${model} يعتبر ${rating >= 4 ? 'موثوقاً' : 'بحاجة رعاية'}. في مناخ الخليج، الحرارة تؤثر على عمر الزيت والأجزاء الداخلية.`,
                'ناقل الحركة': `ناقل الحركة في ${make} ${model} ${rating >= 4 ? 'متين' : 'بحاجة فحص دوري'}. التغيرات الحرارية في الخليج تؤثر على السوائل والأجزاء.`,
                'النظام الكهربائي': 'النظام الكهربائي حساس للحرارة العالية في الخليج. البطارية والأسلاك تحتاج فحصاً دورياً.',
                'نظام التعليق': 'نظام التعليق يتأثر بطبيعة الطرق في الخليج. الأجزاء تبلى أسرع في المناخ الحار.',
                'نظام الفرامل': 'نظام الفرامل من أهم أنظمة السلامة. في الزحام الخليجي، البطانات تبلى أسرع.',
                'نظام التكييف': 'نظام التكييف أساسي في الخليج. العمل المستمر في الحرارة يزيد العبء على النظام.'
            };
            
            return overviews[component] || 'أداء جيد بشكل عام';
        }

        function generateComponentProblems(component, rating) {
            const problems = [];
            
            if (rating < 3) {
                problems.push({
                    title: 'تآكل سريع',
                    cost: '500-1,000 ر.س',
                    urgency: 'عالي',
                    description: 'تآكل أسرع من المتوسط في الأجزاء'
                });
            } else if (rating < 4) {
                problems.push({
                    title: 'صيانة دورية مطلوبة',
                    cost: '300-600 ر.س',
                    urgency: 'متوسط',
                    description: 'يحتاج فحص وصيانة مستمرة'
                });
            } else {
                problems.push({
                    title: 'صيانة وقائية',
                    cost: '200-400 ر.س',
                    urgency: 'منخفض',
                    description: 'ينصح بالصيانة الوقائية فقط'
                });
            }
            
            return problems;
        }

        function generateMaintenanceTips(component, rating) {
            const tips = [];
            
            switch(component) {
                case 'المحرك':
                    tips.push('تغيير الزيت كل 8,000 كم');
                    tips.push('فحص مستوى الزيت أسبوعياً');
                    if (rating < 4) tips.push('مراقبة درجة حرارة المحرك');
                    break;
                case 'ناقل الحركة':
                    tips.push('تغيير سائل الناقل كل 60,000 كم');
                    tips.push('فحص النظام عند أي صوت غريب');
                    break;
                case 'النظام الكهربائي':
                    tips.push('فحص البطارية قبل الصيف');
                    tips.push('تنظيف أقطاب البطارية');
                    break;
                case 'نظام التعليق':
                    tips.push('فحص التعليق كل 20,000 كم');
                    tips.push('تجنب المطبات العالية');
                    break;
                case 'نظام الفرامل':
                    tips.push('فحص الفرامل كل 10,000 كم');
                    tips.push('تغيير سائل الفرامل سنوياً');
                    break;
                case 'نظام التكييف':
                    tips.push('تنظيف المكثف سنوياً');
                    tips.push('تشغيل التكييف أسبوعياً');
                    break;
            }
            
            return tips;
        }

        // ====== MOCK REPORT FOR FALLBACK ======
        function generateMockReport(carData) {
            const make = carData.make;
            const model = carData.model;
            const year = parseInt(carData.year);
            const mileage = carData.mileage ? parseInt(carData.mileage) : 0;
            
            // Base reliability calculation
            let baseRating = 4.0;
            
            // Adjust based on make
            const makeRatings = {
                'تويوتا': 4.5, 'لكزس': 4.4, 'هوندا': 4.3,
                'ميتسوبيشي': 4.2, 'سوبارو': 4.1, 'مازدا': 4.0,
                'هيونداي': 3.9, 'كيا': 3.8, 'نيسان': 3.7,
                'فورد': 3.6, 'شيفروليه': 3.5, 'GMC': 3.4
            };
            
            if (makeRatings[make]) {
                baseRating = makeRatings[make];
            }
            
            // Adjust for year
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            if (age > 10) baseRating -= 0.4;
            else if (age > 5) baseRating -= 0.2;
            else if (age < 3) baseRating += 0.2;
            
            // Adjust for mileage
            if (mileage > 200000) baseRating -= 0.5;
            else if (mileage > 100000) baseRating -= 0.3;
            else if (mileage < 50000) baseRating += 0.2;
            
            // Ensure bounds
            baseRating = Math.max(1, Math.min(5, baseRating));
            
            // Create report
            const report = {
                ...carData,
                title: `${make} ${model} ${year} ${carData.gcc ? '(مواصفات الخليج)' : ''}`,
                overallRating: baseRating,
                confidence: 85 + Math.floor(Math.random() * 10),
                summary: generateDefaultSummary(carData, baseRating),
                components: generateComponentsFromAI('', make, model, baseRating),
                commonProblems: generateDefaultProblems(make, model),
                gulfAdvice: generateDefaultGulfAdvice(),
                analysisDate: new Date().toLocaleDateString('ar-SA'),
                id: Date.now(),
                isMock: true
            };
            
            return report;
        }

        // ====== DISPLAY FUNCTIONS ======
        function showScreen(screen) {
            // Hide all screens
            $('#welcomeScreen, #loadingState, #resultsState, #comparisonState').addClass('d-none');
            
            // Show requested screen
            switch(screen) {
                case 'welcome':
                    $('#welcomeScreen').removeClass('d-none');
                    break;
                case 'loading':
                    $('#loadingState').removeClass('d-none');
                    break;
                case 'results':
                    $('#resultsState').removeClass('d-none');
                    break;
                case 'comparison':
                    $('#comparisonState').removeClass('d-none');
                    break;
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function displayCarReport(report) {
            const resultsDiv = $('#resultsState');
            resultsDiv.html(generateReportHTML(report));
            
            // Add event listeners to component cards
            $('.component-card').click(function() {
                const componentName = $(this).data('component');
                const component = report.components.find(c => c.name === componentName);
                if (component) {
                    showComponentModal(component);
                }
            });
        }

        function generateReportHTML(report) {
            const ratingClass = getRatingClass(report.overallRating);
            const starsHTML = generateStarsHTML(report.overallRating);
            
            return `
                <div class="report-header">
                    <div class="d-flex align-center justify-between mb-4">
                        <div>
                            <h1 class="car-title">${report.title}</h1>
                            <p class="car-subtitle">
                                <i class="fas fa-calendar"></i> ${report.year} 
                                <i class="fas fa-tachometer-alt" style="margin-right: 16px;"></i> 
                                ${report.mileage ? report.mileage.toLocaleString('ar') + ' كم' : 'ميلافة غير محددة'}
                                ${report.gcc ? '<span style="background: #10B981; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">GCC</span>' : ''}
                                ${report.isMock ? '<span style="background: #F59E0B; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">بيانات تجريبية</span>' : ''}
                            </p>
                        </div>
                        <button class="btn btn-secondary" id="addToCompareBtn" onclick="addToComparison(${report.id})">
                            <i class="fas fa-balance-scale"></i>
                            أضف للمقارنة
                        </button>
                    </div>
                    
                    <div class="rating-summary">
                        <div class="overall-rating">
                            <div class="rating-badge ${ratingClass}">
                                ${report.overallRating.toFixed(1)}
                            </div>
                            <div>
                                <div class="rating-stars">
                                    ${starsHTML}
                                </div>
                                <div class="rating-label">
                                    ${getRatingText(report.overallRating)} • ثقة التحليل: ${report.confidence}%
                                </div>
                            </div>
                        </div>
                        <div class="summary-text">
                            ${report.summary}
                        </div>
                    </div>
                </div>
                
                <h3 class="form-title mb-8">
                    <i class="fas fa-cogs"></i>
                    تحليل الأجزاء الرئيسية
                </h3>
                
                <div class="components-grid">
                    ${report.components.map(comp => `
                        <div class="component-card" data-component="${comp.name}">
                            <div class="component-header">
                                <h3 class="component-name">
                                    ${comp.icon} ${comp.name}
                                </h3>
                                <div class="component-rating ${comp.ratingClass}">
                                    ${comp.rating.toFixed(1)}/5
                                </div>
                            </div>
                            <div class="rating-bar">
                                <div class="rating-fill" style="width: ${(comp.rating / 5) * 100}%; background: ${comp.ratingColor};"></div>
                            </div>
                            <p style="color: var(--gray-600); margin-top: 12px; line-height: 1.6;">
                                ${comp.summary}
                            </p>
                            <div style="margin-top: 16px; color: var(--gray-500); font-size: 14px;">
                                <i class="fas fa-info-circle"></i> انقر للتفاصيل والمشاكل
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <h3 class="form-title mb-8 mt-8">
                    <i class="fas fa-exclamation-triangle"></i>
                    المشاكل الشائعة وتكاليف الإصلاح
                </h3>
                
                <div class="components-grid">
                    ${report.commonProblems.map(problem => `
                        <div class="component-card">
                            <div class="component-header">
                                <h3 class="component-name" style="color: ${getUrgencyColor(problem.urgency)};">
                                    <i class="fas fa-exclamation-circle"></i>
                                    ${problem.title}
                                </h3>
                                <div style="background: ${getUrgencyColor(problem.urgency)}15; color: ${getUrgencyColor(problem.urgency)}; padding: 6px 12px; border-radius: 6px; font-weight: 700;">
                                    ${problem.cost}
                                </div>
                            </div>
                            <p style="color: var(--gray-700); margin: 12px 0; line-height: 1.6;">
                                ${problem.description}
                            </p>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px;">
                                <span style="background: var(--gray-100); padding: 6px 12px; border-radius: 6px; font-size: 14px;">
                                    <i class="fas fa-chart-line"></i> ${problem.frequency}
                                </span>
                                <span style="background: var(--gray-100); padding: 6px 12px; border-radius: 6px; font-size: 14px;">
                                    <i class="fas fa-tachometer-alt"></i> ${problem.typicalMileage}
                                </span>
                                <span style="background: ${getUrgencyColor(problem.urgency)}15; color: ${getUrgencyColor(problem.urgency)}; padding: 6px 12px; border-radius: 6px; font-size: 14px;">
                                    <i class="fas fa-flag"></i> ${problem.urgency}
                                </span>
                            </div>
                            ${problem.solution ? `
                            <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-right: 4px solid var(--success);">
                                <strong style="color: var(--success); display: block; margin-bottom: 4px;">
                                    <i class="fas fa-lightbulb"></i> الحل المقترح:
                                </strong>
                                <p style="color: var(--gray-700); margin: 0; font-size: 14px;">${problem.solution}</p>
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <h3 class="form-title mb-8 mt-8">
                    <i class="fas fa-sun"></i>
                    نصائح خاصة لمناخ الخليج
                </h3>
                
                <div class="components-grid">
                    ${report.gulfAdvice.map(advice => `
                        <div class="component-card">
                            <div class="component-header">
                                <h3 class="component-name">
                                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    ${advice.title}
                                </h3>
                            </div>
                            <p style="color: var(--gray-700); line-height: 1.6;">
                                ${advice.description}
                            </p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showComponentModal(component) {
            const modal = $('#componentModal');
            const content = $('#modalContent');
            
            content.html(`
                <div class="rating-summary mb-8">
                    <div class="overall-rating">
                        <div class="rating-badge ${component.ratingClass}" style="width: 60px; height: 60px; font-size: 1.5rem;">
                            ${component.rating.toFixed(1)}
                        </div>
                        <div>
                            <div class="rating-stars">
                                ${generateStarsHTML(component.rating)}
                            </div>
                            <div class="rating-label">
                                ${getRatingText(component.rating)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h4 style="color: var(--dark); margin-bottom: 12px;">📊 نظرة عامة</h4>
                    <p style="color: var(--gray-700); line-height: 1.6;">
                        ${component.detailedOverview}
                    </p>
                </div>
                
                <div class="mb-8">
                    <h4 style="color: var(--dark); margin-bottom: 12px;">⚠️ المشاكل الشائعة</h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${component.commonProblems.map(problem => `
                            <div style="padding: 16px; background: #fef2f2; border-radius: var(--radius-md); border-right: 4px solid #fca5a5;">
                                <div class="d-flex align-center justify-between mb-8">
                                    <strong style="color: var(--dark);">${problem.title}</strong>
                                    <span style="color: #ef4444; font-weight: 700;">${problem.cost}</span>
                                </div>
                                <p style="color: var(--gray-700); margin: 0; font-size: 15px;">${problem.description}</p>
                                <div style="margin-top: 12px;">
                                    <span style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 14px;">
                                        <i class="fas fa-flag"></i> ${problem.urgency}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--dark); margin-bottom: 12px;">💡 نصائح الصيانة</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${component.maintenanceTips.map(tip => `
                            <div style="padding: 12px 16px; background: #f0fdf4; border-radius: var(--radius-md); border-right: 4px solid #86efac;">
                                <p style="color: var(--gray-700); margin: 0; display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #10b981; margin-left: 8px; margin-top: 3px;"></i>
                                    ${tip}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `);
            
            $('#modalComponentName').text(component.name);
            modal.addClass('active');
            $('body').css('overflow', 'hidden');
        }

        function closeModal() {
            $('#componentModal').removeClass('active');
            $('body').css('overflow', 'auto');
        }

        // ====== COMPARISON FUNCTIONS ======
        function addToComparison(reportId) {
            if (!APP_STATE.currentCar) return;
            
            if (APP_STATE.comparisonCars.length >= 2) {
                showNotification('يمكنك مقارنة سيارتين فقط', 'warning');
                return;
            }
            
            // Check if already in comparison
            if (APP_STATE.comparisonCars.some(car => car.id === reportId)) {
                showNotification('السيارة مضاف بالفعل للمقارنة', 'info');
                return;
            }
            
            APP_STATE.comparisonCars.push(APP_STATE.currentCar);
            showNotification('تمت إضافة السيارة للمقارنة', 'success');
            
            // Update compare form
            if (APP_STATE.comparisonCars.length === 1) {
                $('#compareCar1').val(`${APP_STATE.currentCar.make} ${APP_STATE.currentCar.model}`);
                $('#compareYear1').val(APP_STATE.currentCar.year);
                $('#compareMileage1').val(APP_STATE.currentCar.mileage || '');
            } else {
                $('#compareCar2').val(`${APP_STATE.currentCar.make} ${APP_STATE.currentCar.model}`);
                $('#compareYear2').val(APP_STATE.currentCar.year);
                $('#compareMileage2').val(APP_STATE.currentCar.mileage || '');
            }
        }

        async function handleComparison() {
            const car1 = $('#compareCar1').val();
            const car2 = $('#compareCar2').val();
            const year1 = $('#compareYear1').val();
            const year2 = $('#compareYear2').val();
            
            if (!car1 || !car2 || !year1 || !year2) {
                showNotification('الرجاء إدخال بيانات السيارتين', 'error');
                return;
            }
            
            // Parse car data
            const carData1 = parseCarString(car1, year1, $('#compareMileage1').val());
            const carData2 = parseCarString(car2, year2, $('#compareMileage2').val());
            
            if (!carData1 || !carData2) {
                showNotification('لم نتعرف على بيانات السيارتين', 'error');
                return;
            }
            
            // Show loading
            showScreen('loading');
            
            try {
                // Get analysis for both cars
                const [report1, report2] = await Promise.all([
                    getCarAnalysis(carData1),
                    getCarAnalysis(carData2)
                ]);
                
                // Store in comparison
                APP_STATE.comparisonCars = [report1, report2];
                
                // Display comparison
                displayComparison();
                showScreen('comparison');
                closeSidebar();
            } catch (error) {
                console.error('Comparison error:', error);
                showNotification('حدث خطأ أثناء المقارنة', 'error');
                showScreen('welcome');
            }
        }

        function displayComparison() {
            const container = $('#comparisonContainer');
            
            if (APP_STATE.comparisonCars.length !== 2) {
                container.html('<p class="text-center">الرجاء إضافة سيارتين للمقارنة</p>');
                return;
            }
            
            const [car1, car2] = APP_STATE.comparisonCars;
            
            container.html(`
                <div class="comparison-container">
                    <div class="comparison-card">
                        <div class="comparison-header">
                            <h3 class="comparison-title">${car1.title}</h3>
                            <div class="rating-badge ${getRatingClass(car1.overallRating)}" style="margin: 0 auto 16px;">
                                ${car1.overallRating.toFixed(1)}
                            </div>
                            <p style="color: var(--gray-600);">${car1.summary}</p>
                        </div>
                        
                        <h4 style="color: var(--dark); margin-bottom: 16px;">📊 مقارنة الأجزاء</h4>
                        ${generateComparisonComponents(car1.components, car2.components, 0)}
                        
                        <h4 style="color: var(--dark); margin-top: 24px; margin-bottom: 16px;">💰 التكاليف التقريبية</h4>
                        <div style="background: #f8fafc; padding: 16px; border-radius: var(--radius-md);">
                            <div style="color: var(--gray-700); margin-bottom: 8px;">
                                إجمالي تكاليف الإصلاحات الشائعة:
                            </div>
                            <div style="color: var(--primary); font-size: 1.5rem; font-weight: 800;">
                                ${calculateTotalCost(car1.commonProblems)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-card">
                        <div class="comparison-header">
                            <h3 class="comparison-title">${car2.title}</h3>
                            <div class="rating-badge ${getRatingClass(car2.overallRating)}" style="margin: 0 auto 16px;">
                                ${car2.overallRating.toFixed(1)}
                            </div>
                            <p style="color: var(--gray-600);">${car2.summary}</p>
                        </div>
                        
                        <h4 style="color: var(--dark); margin-bottom: 16px;">📊 مقارنة الأجزاء</h4>
                        ${generateComparisonComponents(car2.components, car1.components, 1)}
                        
                        <h4 style="color: var(--dark); margin-top: 24px; margin-bottom: 16px;">💰 التكاليف التقريبية</h4>
                        <div style="background: #f8fafc; padding: 16px; border-radius: var(--radius-md);">
                            <div style="color: var(--gray-700); margin-bottom: 8px;">
                                إجمالي تكاليف الإصلاحات الشائعة:
                            </div>
                            <div style="color: var(--primary); font-size: 1.5rem; font-weight: 800;">
                                ${calculateTotalCost(car2.commonProblems)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="report-header mt-8">
                    <h3 class="car-title">🎯 التوصية النهائية</h3>
                    <p class="car-subtitle">بناءً على تحليل الذكاء الاصطناعي</p>
                    <div style="padding: 24px; background: ${car1.overallRating > car2.overallRating ? '#f0fdf4' : '#fef2f2'}; border-radius: var(--radius-md); margin-top: 16px;">
                        <p style="color: var(--gray-700); font-size: 1.125rem; line-height: 1.6;">
                            ${generateRecommendation(car1, car2)}
                        </p>
                    </div>
                </div>
            `);
        }

        function generateComparisonComponents(components1, components2, index) {
            return components1.map(comp1 => {
                const comp2 = components2.find(c => c.name === comp1.name) || { rating: 3 };
                const isBetter = comp1.rating > comp2.rating;
                const isEqual = comp1.rating === comp2.rating;
                
                return `
                    <div style="margin-bottom: 12px;">
                        <div class="d-flex align-center justify-between mb-2">
                            <span style="color: var(--dark); font-weight: 600;">${comp1.name}</span>
                            <span class="${getRatingClass(comp1.rating)}" style="font-weight: 700;">${comp1.rating.toFixed(1)}</span>
                        </div>
                        <div class="rating-bar" style="position: relative;">
                            <div class="rating-fill" style="width: ${(comp1.rating / 5) * 100}%; background: ${getRatingColor(comp1.rating)}; position: absolute;"></div>
                            <div class="rating-fill" style="width: ${(comp2.rating / 5) * 100}%; background: ${getRatingColor(comp2.rating)}; opacity: 0.5; position: absolute;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: var(--gray-500); font-size: 12px;">
                                ${isBetter ? '🟢 أفضل' : isEqual ? '⚪ متساوي' : '🔴 أقل'}
                            </span>
                            <span style="color: var(--gray-500); font-size: 12px;">
                                الفرق: ${Math.abs(comp1.rating - comp2.rating).toFixed(1)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateTotalCost(problems) {
            let total = 0;
            problems.forEach(problem => {
                const costMatch = problem.cost.match(/(\d+,\d+|\d+)/);
                if (costMatch) {
                    const cost = parseInt(costMatch[0].replace(',', ''));
                    total += cost;
                }
            });
            return total.toLocaleString('ar') + ' ر.س';
        }

        function generateRecommendation(car1, car2) {
            if (car1.overallRating > car2.overallRating) {
                return `بناءً على التحليل، ${car1.make} ${car1.model} أفضل موثوقية بنسبة ${((car1.overallRating - car2.overallRating) * 20).toFixed(0)}% من ${car2.make} ${car2.model}. نوصي بها للاستخدام الطويل الأمد في مناخ الخليج.`;
            } else if (car2.overallRating > car1.overallRating) {
                return `بناءً على التحليل، ${car2.make} ${car2.model} أفضل موثوقية بنسبة ${((car2.overallRating - car1.overallRating) * 20).toFixed(0)}% من ${car1.make} ${car1.model}. نوصي بها للاستخدام الطويل الأمد في مناخ الخليج.`;
            } else {
                return `السيارتان متساويتان تقريباً في الموثوقية. نوصي باختيار ${car1.make} ${car1.model} إذا كنت تفضل ${car1.make}، أو ${car2.make} ${car2.model} إذا كنت تفضل ${car2.make}.`;
            }
        }

        // ====== UTILITY FUNCTIONS ======
        function parseCarString(carString, year, mileage) {
            const parts = carString.split(' ');
            if (parts.length < 2) return null;
            
            const make = parts[0];
            const model = parts.slice(1).join(' ');
            
            return {
                make: make,
                model: model,
                year: year,
                mileage: mileage || null,
                gcc: true
            };
        }

        function getRatingClass(rating) {
            if (rating >= 4.5) return 'rating-excellent';
            if (rating >= 4.0) return 'rating-good';
            if (rating >= 3.0) return 'rating-average';
            if (rating >= 2.0) return 'rating-poor';
            return 'rating-bad';
        }

        function getRatingColor(rating) {
            if (rating >= 4.5) return '#10B981';
            if (rating >= 4.0) return '#3B82F6';
            if (rating >= 3.0) return '#F59E0B';
            if (rating >= 2.0) return '#F97316';
            return '#EF4444';
        }

        function getRatingText(rating) {
            if (rating >= 4.5) return 'ممتاز';
            if (rating >= 4.0) return 'جيد جداً';
            if (rating >= 3.0) return 'متوسط';
            if (rating >= 2.0) return 'ضعيف';
            return 'سيء';
        }

        function getUrgencyColor(urgency) {
            switch(urgency) {
                case 'عالي': return '#EF4444';
                case 'متوسط': return '#F59E0B';
                case 'منخفض': return '#10B981';
                default: return '#6B7280';
            }
        }

        function generateStarsHTML(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating - fullStars >= 0.3;
            
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            
            return stars;
        }

        // ====== HISTORY FUNCTIONS ======
        function addToHistory(carData) {
            const historyEntry = {
                ...carData,
                timestamp: new Date().toLocaleString('ar-SA'),
                id: Date.now()
            };
            
            APP_STATE.searchHistory.unshift(historyEntry);
            APP_STATE.searchHistory = APP_STATE.searchHistory.slice(0, 10);
            localStorage.setItem('carSearchHistory', JSON.stringify(APP_STATE.searchHistory));
            
            updateHistoryList();
        }

        function updateHistoryList() {
            const historyList = $('#historyList');
            historyList.empty();
            
            if (APP_STATE.searchHistory.length === 0) {
                historyList.html(`
                    <div class="text-center" style="color: var(--gray-500); padding: 40px 20px;">
                        <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>لا يوجد سجل بحث حتى الآن</p>
                    </div>
                `);
                return;
            }
            
            APP_STATE.searchHistory.forEach(entry => {
                const item = $(`
                    <div class="component-card" style="cursor: pointer; margin-bottom: 12px;" onclick="loadFromHistory(${entry.id})">
                        <div class="d-flex align-center justify-between">
                            <div>
                                <strong style="color: var(--dark);">${entry.make} ${entry.model}</strong>
                                <div style="color: var(--gray-500); font-size: 14px; margin-top: 4px;">
                                    <i class="far fa-calendar"></i> ${entry.year}
                                    ${entry.mileage ? ` • <i class="fas fa-tachometer-alt"></i> ${entry.mileage} كم` : ''}
                                </div>
                            </div>
                            <div style="color: var(--gray-400); font-size: 12px;">
                                ${entry.timestamp}
                            </div>
                        </div>
                    </div>
                `);
                historyList.append(item);
            });
        }

        async function loadFromHistory(id) {
            const entry = APP_STATE.searchHistory.find(item => item.id === id);
            if (!entry) return;
            
            // Close sidebar
            closeSidebar();
            
            // Show loading
            showScreen('loading');
            
            try {
                const report = await getCarAnalysis(entry);
                APP_STATE.currentCar = report;
                displayCarReport(report);
                showScreen('results');
            } catch (error) {
                console.error('Error:', error);
                showNotification('حدث خطأ أثناء تحميل التقرير', 'error');
                showScreen('welcome');
            }
        }

        function clearHistory() {
            if (confirm('هل أنت متأكد من مسح سجل البحث بالكامل؟')) {
                APP_STATE.searchHistory = [];
                localStorage.removeItem('carSearchHistory');
                updateHistoryList();
                showNotification('تم مسح سجل البحث', 'success');
            }
        }

        // ====== TEST API FUNCTION ======
        async function testAPIConnection() {
            showNotification('جاري اختبار اتصال DeepSeek API...', 'info');
            
            try {
                const response = await axios.post(APP_STATE.apiBaseUrl, {
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'user',
                            content: 'مرحباً، هل تعمل؟'
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 100
                }, {
                    headers: {
                        'Authorization': `Bearer ${APP_STATE.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.data.choices && response.data.choices[0]) {
                    showNotification('✅ API يعمل بشكل صحيح! يمكنك الآن استخدام الذكاء الاصطناعي.', 'success');
                    console.log('API Test Response:', response.data);
                } else {
                    showNotification('⚠️ API يعمل ولكن هناك مشكلة في الاستجابة', 'warning');
                }
            } catch (error) {
                console.error('API Test Error:', error);
                showNotification('❌ خطأ في اتصال API. تحقق من المفتاح والشبكة.', 'error');
            }
        }

        // ====== THEME & LANGUAGE ======
        function toggleTheme() {
            APP_STATE.theme = APP_STATE.theme === 'light' ? 'dark' : 'light';
            setTheme(APP_STATE.theme);
            localStorage.setItem('theme', APP_STATE.theme);
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.style.setProperty('--dark', '#F9FAFB');
                document.documentElement.style.setProperty('--light', '#111827');
                document.documentElement.style.setProperty('--gray-50', '#1F2937');
                document.documentElement.style.setProperty('--gray-100', '#374151');
                document.documentElement.style.setProperty('--gray-200', '#4B5563');
                document.documentElement.style.setProperty('--gray-900', '#F9FAFB');
                $('body').css('background', 'linear-gradient(135deg, #111827 0%, #1F2937 100%)');
            } else {
                document.documentElement.style.setProperty('--dark', '#111827');
                document.documentElement.style.setProperty('--light', '#F9FAFB');
                document.documentElement.style.setProperty('--gray-50', '#F9FAFB');
                document.documentElement.style.setProperty('--gray-100', '#F3F4F6');
                document.documentElement.style.setProperty('--gray-200', '#E5E7EB');
                document.documentElement.style.setProperty('--gray-900', '#111827');
                $('body').css('background', 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)');
            }
            
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = $('#themeToggle i');
            if (APP_STATE.theme === 'dark') {
                icon.removeClass('fa-moon').addClass('fa-sun');
            } else {
                icon.removeClass('fa-sun').addClass('fa-moon');
            }
        }

        function toggleLanguage() {
            // In production, implement full translation
            showNotification('دعم الترجمة الكاملة قريباً', 'info');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = $(`
                <div style="
                    position: fixed;
                    top: 80px;
                    left: 20px;
                    right: 20px;
                    max-width: 400px;
                    margin: 0 auto;
                    padding: 16px 20px;
                    background: ${type === 'error' ? '#FEF2F2' : type === 'success' ? '#F0FDF4' : type === 'warning' ? '#FFFBEB' : '#F0F7FF'};
                    border: 1px solid ${type === 'error' ? '#FECACA' : type === 'success' ? '#BBF7D0' : type === 'warning' ? '#FDE68A' : '#BFDBFE'};
                    border-right: 4px solid ${type === 'error' ? '#EF4444' : type === 'success' ? '#10B981' : type === 'warning' ? '#F59E0B' : '#3B82F6'};
                    color: ${type === 'error' ? '#DC2626' : type === 'success' ? '#059669' : type === 'warning' ? '#D97706' : '#1D4ED8'};
                    border-radius: var(--radius-md);
                    z-index: 9999;
                    box-shadow: var(--shadow-lg);
                    animation: fadeIn var(--transition-base);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                ">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button style="background: none; border: none; color: inherit; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            
            $('body').append(notification);
            
            // Auto remove
            setTimeout(() => {
                notification.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 5000);
            
            // Close button
            notification.find('button').click(function() {
                notification.remove();
            });
        }

        // ====== DEMO FUNCTION ======
        function showDemoReport() {
            const demoData = {
                make: 'تويوتا',
                model: 'كامري',
                year: '2020',
                mileage: '75000',
                transmission: 'automatic',
                fuel: 'petrol',
                gcc: true
            };
            
            // Show loading
            showScreen('loading');
            
            // Get analysis
            getCarAnalysis(demoData).then(report => {
                APP_STATE.currentCar = report;
                displayCarReport(report);
                showScreen('results');
                closeSidebar();
            }).catch(error => {
                console.error('Demo error:', error);
                showNotification('حدث خطأ في العرض التجريبي', 'error');
                showScreen('welcome');
            });
        }
    </script>
</body>
</html>
